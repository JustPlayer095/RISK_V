## Модуль `config`

Директория `config` отвечает за хранение и загрузку пользовательской конфигурации устройства во внешней EEPROM.  
Основная задача модуля — предоставить простой интерфейс чтения/записи структуры настроек, не заставляя остальной код работать с низкоуровневым протоколом SPI/I2C.

### Что за конфиг хранится

В заголовке `config.h` определена структура:

- `config_storage_t` — упакованная структура с полями:
  - `osdp_addr` — адрес устройства в сети OSDP;
  - `osdp_baud` — скорость UART/OSDP в бодах;
  - `pin_cfg[16]` — резерв/место под конфигурацию пинов (на будущее).
- Также есть макрос `CONFIG_EEPROM_BASE` — базовый адрес области в EEPROM, где хранится конфигурация.

Эта структура воспринимается как «снимок настроек», который целиком читается и записывается в EEPROM.

### Файл `config.c`

Реализует три основные функции работы с конфигом:

- `config_storage_default(config_storage_t *cfg)`  
  Заполняет структуру значениями по умолчанию.  
  Сейчас это:
  - адрес OSDP `0x01`;
  - скорость `115200`.

- `config_storage_load(config_storage_t *cfg)`  
  Пытается прочитать конфиг из EEPROM по адресу `CONFIG_EEPROM_BASE`:
  - делает асинхронный запрос `eeprom_read_bytes(...)` к драйверу EEPROM;
  - ждёт завершения операции через `eeprom_is_busy()` с таймаутом в миллисекундах по глобальному счётчику `ms_ticks`;
  - проверяет наличие ошибок по `eeprom_had_error()`;
  - дополнительно делает повторное чтение, если первый раз вернулись только нули (защита от «пустой» или ещё не готовой памяти);
  - в случае успеха копирует прочитанную структуру в `cfg`.
  Если что-то пошло не так (таймаут или ошибка), функция возвращает `false`, и вызывающая сторона может записать значения по умолчанию.

- `config_storage_save(const config_storage_t *cfg_in)`  
  Записывает структуру в EEPROM тем же блоком:
  - копирует входную структуру во временную переменную;
  - вызывает `eeprom_write_bytes(...)`;
  - ждёт окончания записи с таймаутом через `ms_ticks`;
  - при ошибке просто выходит (верхний уровень может повторить попытку или сообщить об ошибке).

### Как это используется в проекте

- В `main.c` в функции `cfg_store_and_report()`:
  - вызывается `config_storage_load(&g_cfg)`;
  - если загрузка не удалась — вызываются `config_storage_default()` и `config_storage_save()` для записи дефолтного конфига;
  - активный конфиг печатается в UART (`printf("CFG active: addr=%u baud=%u\r\n", ...)`).
- Модуль `osdp` также использует `config_storage_load()` и `config_storage_save()` при обработке команды `osdp_COMSET`, чтобы:
  - считать текущие настройки;
  - обновить адрес и скорость, пришедшие по OSDP;
  - сохранить новые значения в EEPROM.

Благодаря этому модулю, логика протокола и основной код работают с конфигом как с обычной C‑структурой, а детали доступа к EEPROM полностью инкапсулированы.

