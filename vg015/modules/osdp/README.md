## Модуль `osdp`

Папка `osdp` реализует протокол OSDP (Open Supervised Device Protocol) поверх UART4 микроконтроллера.  
Модуль принимает байты из UART (через обработчик прерываний в `main.c`), собирает и проверяет кадры, обрабатывает стандартные команды (POLL, ID, CAP, ISTAT, OSTAT, OUT, LED, COMSET) и формирует корректные ответы, включая CRC.

### Файлы

- `osdp.h` — заголовок:
  - перечисляет коды команд и ответов OSDP (POLL, ID, CAP, ISTAT, OSTAT, OUT, LED, COMSET, ACK, NAK и т.д.);
  - объявляет функции:
    - `osdp_init()` — инициализация внутреннего состояния протокола (адрес устройства, скорость, таймеры выходов/LED);
    - `osdp_on_rx_byte(uint8_t byte)` — приём одного байта протокола (вызывается из обработчика UART);
    - `osdp_tick_1ms()` — периодический вызов раз в 1 мс для обслуживания таймеров.

- `osdp.c` — основная логика протокола:
  - использует `ccitt_crc16` для подсчёта и проверки CRC кадров;
  - хранит в RAM текущий OSDP‑адрес и скорость (`g_addr`, `g_baud`) и загружает их из EEPROM (`osdp_load_addr_baud()` через модуль `config`);
  - реализует простейший конечный автомат приёма (`rx_state_t`), который:
    - ждёт байт `SOM` (0x53), затем адрес, длину кадра и полезные данные;
    - проверяет корректность длины и CRC;
    - передаёт корректные кадры на обработку команд.

  Обработка команд:
  - `osdp_POLL` — отвечает `osdp_ACK`;
  - `osdp_ID` — возвращает идентификатор устройства (условные поля PDID);
  - `osdp_CAP` — возвращает таблицу возможностей (количество входов/выходов, поддержка CRC и пр.);
  - `osdp_ISTAT` — формирует ответ с состоянием входов (кнопки PA0–PA3);
  - `osdp_OSTAT` — формирует ответ с состоянием выходов (светодиоды PA4–PA7);
  - `osdp_OUT` — вызывает `handle_osdp_out()` и управляет выходами, храня состояние и таймеры в структуре `output_ctrl_t` для каждого из 4 выходов;
  - `osdp_LED` — вызывает `handle_osdp_led()` и управляет профилем мигания LED через структуру `led_ctrl_t` и функцию `set_led_state()`;
  - `osdp_COMSET` — принимает новые адрес и скорость, отправляет ответ `osdp_COM`, сохраняет новые значения в EEPROM (через `config_storage_load/save`) и обновляет UART, вызывая `set_uart_baud()`.

  Функция `osdp_tick_1ms()`:
  - вызывается раз в 1 мс из обработчика таймера TMR32 (`tmr32_irq_handler` в `main.c`);
  - уменьшает таймеры временных состояний выходов (OUT) и при их истечении возвращает постоянное состояние;
  - управляет фазами мигания LED (в т.ч. временными профилями) согласно настройкам, полученным по команде `osdp_LED`.

- `ccitt_crc16.c` / `ccitt_crc16.h` — реализация и интерфейс CRC‑16/CCITT:
  - содержит таблицу для быстрого пересчёта CRC;
  - функции `ccitt_crc16_update()`, `ccitt_crc16_calc()` и `osdp_crc_is_ok()` упрощают подсчёт и проверку контрольной суммы кадра.

### Взаимодействие с остальным кодом

- В `main.c`:
  - обработчик прерываний UART4 (`uart4_irq_handler`) читает все принятые байты из регистра UART и передаёт каждый байт в `osdp_on_rx_byte(ch)`;
  - обработчик таймера `tmr32_irq_handler` вызывает `osdp_tick_1ms()`.
- Через модуль `config`:
  - `osdp` загружает и сохраняет настройки адреса и скорости по сети OSDP;
  - благодаря этому адрес и скорость сохраняются в EEPROM и не теряются при перезагрузке.
- Через GPIO:
  - `osdp` управляет состоянием светодиодов и логических выходов, используя `GPIO_SetBits`/`GPIO_ClearBits` для пинов порта GPIOA.

В результате модуль `osdp` полностью инкапсулирует OSDP‑протокол: остальной код лишь передаёт ему принятые байты и даёт периодический «тик» в миллисекундах.

