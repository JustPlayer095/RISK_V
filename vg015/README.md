## Проект `vg015`

Этот проект — пример прошивки для микроконтроллера К1921ВГ015, который:
- инициализирует тактирование и базовые системные функции;
- настраивает UART4 для обмена по протоколу OSDP и вывода логов;
- опрашивает АЦП (ADCSAR), классифицирует уровень сигнала по порогам и печатает состояние;
- обрабатывает нажатия кнопок на порту GPIOA (PA0–PA3) и управляет светодиодами (PA4–PA7);
- хранит пользовательский конфиг (адрес и скорость OSDP/UART и др.) во внешней EEPROM.

### Основной поток работы

- В `main.c` вызывается функция `periph_init()`, которая:
  - выполняет `SystemInit()` и `SystemCoreClockUpdate()` (инициализация тактирования МК);
  - настраивает перенаправление `printf` в UART (`retarget_init()`);
  - инициализирует АЦП (`adcsar_init()`), драйвер EEPROM (`eeprom_init()`), GPIO и таймер TMR32 на 1 мс;
  - включает прерывания UART4 и GPIO через контроллер прерываний PLIC;
  - инициализирует стек протокола OSDP (`osdp_init()`);
  - загружает конфиг из EEPROM и при необходимости записывает значения по умолчанию (`cfg_store_and_report()`);
  - запускает непрерывные измерения АЦП (`adcsar_start()`).
- Таймер TMR32 генерирует прерывание раз в 1 мс, в обработчике:
  - увеличивается счётчик `ms_ticks`;
  - вызывается `osdp_tick_1ms()` для обслуживания временных эффектов (мигание LED, таймеры выходов).
- Обработчик прерывания UART4 (`uart4_irq_handler`) читает принятые байты и передаёт их в `osdp_on_rx_byte()` для разбора кадров OSDP.
- Обработчик прерываний GPIO (`gpio_irq_handler`) обрабатывает кнопки PA0–PA3 с антидребезгом и переключает соответствующие светодиоды PA4–PA7.
- В основном цикле `while(1)`:
  - периодически вызывается `adcsar_poll()`, которая возвращает структуру `adcsar_sample_t` с «сырым» кодом АЦП и символьным состоянием (`state_char`);
  - при устойчивом изменении состояния (c учётом задержки подтверждения) оно выводится в UART;
  - ядро переводится в режим ожидания прерываний (`wfi`).

### Каталоги проекта `vg015`

- `adcsar` — модуль работы с АЦП (ADCSAR): инициализация, запуск преобразований, выборка результатов, классификация по порогам и представление результата в виде состояния (`SHORT/ALARM/NORMAL/TAMPER`).
- `config` — сохранение и загрузка пользовательского конфига (адрес и скорость OSDP/UART и др.) во внешней EEPROM.
- `driver` — низкоуровневый драйвер внешней EEPROM поверх SPI (при желании может быть собран и I2C‑вариант).
- `gpio` — удобные вспомогательные функции для инициализации GPIO в режимы ввода/вывода и настройки прерываний на кнопки.
- `osdp` — реализация протокола OSDP поверх UART4: разбор команд, формирование ответов, управление выходами и LED.
- `device/Source` и `device/Include` — стартовый код и системные функции производителя МК (инициализация памяти, тактирования, PLIC, обработка исключений и др.).
- `plib` — стандартная периферийная библиотека PLIB015 от АО «НИИЭТ», используемая для работы с GPIO, таймерами, АЦП, UART и другими блоками. Подробное описание см. в `plib/README.md`.

### Связи модулей

- `main.c` использует:
  - `adcsar` для периодического опроса АЦП и получения состояния по уровню сигнала;
  - `config` и `driver/eeprom` для загрузки/сохранения настроек OSDP;
  - `gpio_helpers` для быстрой настройки портов GPIOA под светодиоды и кнопки с прерываниями;
  - `osdp` для обработки байтов, приходящих по UART4, и формирования ответов.
- `osdp` в свою очередь:
  - обращается к `config` для чтения и записи настроек при обработке команды `osdp_COMSET`;
  - управляет выводами GPIOA (светодиодами и «выходами») и использует `osdp_tick_1ms()` из таймера для реализации таймеров и миганий;
  - использует `ccitt_crc16` для подсчёта и проверки CRC кадров.

